# 2025-11-06 开发更新记录

## 已完成内容

- **档案数据模型落地**
  - 编写中英文双语设计文档 `docs/patient-profile.md`，明确 `patient_profiles` 及四类子表（肌力测量、功能测试、活动日志、报告文档）的字段、索引、迁移计划与后续路线。
  - 调整 `db/init_db.sql`：扩展 `patient_profiles` 字段、移除旧的 `muscle_strength` JSON，新增唯一索引，并创建 `patient_measurements`、`patient_function_tests`、`patient_activity_logs`、`patient_documents` 等子表及索引，同时在创建触发器前添加 `DROP TRIGGER IF EXISTS`，确保脚本可重复执行。

- **后端 API 支撑**
  - 新增 JWT 鉴权中间件 `apps/api/src/middleware/require-auth.ts`，统一解析 Bearer Token。
  - 实现患者档案模块（service/controller/schema/routes），并在 `/api/profiles` 下提供：
    - `POST /api/profiles` 创建个人档案
    - `GET /api/profiles/me` 查询自己的档案
    - `PUT /api/profiles/me` 更新档案
    - `POST /api/profiles/me/measurements`、`/function-tests`、`/activity-logs`、`/documents` 写入子资源
  - 按 ESLint 规范整理各文件导入顺序，`npm run lint --workspace @openrd/api -- --fix` 现可通过。

- **本地验证**
  - 使用 `psql -U jiexiaofang -d postgres -f db/init_db.sql` 同步数据库结构。
  - 通过 `curl` 注册/登录获得 JWT，并成功访问 `/api/profiles`、`/api/profiles/me/measurements`，验证数据流通。

## 当前状态

- `git status` 显示新增/修改文件包括：`docs/patient-profile.md`、`docs/update-2025-11-06.md`、`db/init_db.sql`、患者档案模块源码与鉴权中间件等。
- 所有变更均通过 ESLint 自动修复；尚未补充自动化测试，后续可考虑 Supertest + Vitest。

## 后续建议

1. **提交与推送**
   - 在默认分支以外（当前 `feature/patient-profile`）执行：
     ```bash
     git add .
     git commit -m "feat: add patient profile data model and API endpoints"
     git push origin feature/patient-profile
     ```
   - 若团队使用 PR 流程，创建 Pull Request，并附上本更新记录及测试步骤。

2. **移动端联调**
   - 将 Expo 表单提交改为调用 `/api/profiles` 和各子接口，展示页消费新结构。

3. **测试与文档**
   - 追加端到端测试覆盖档案创建/查询/鉴权。
   - 将本文件和 `docs/patient-profile.md` 引入团队 wiki 或 README，提醒数据库脚本改动。

## 参考命令

```bash
# 1. 更新数据库
psql -U jiexiaofang -d postgres -f db/init_db.sql

# 2. 启动 API
npm run dev --workspace @openrd/api

# 3. 注册 / 登录
curl -X POST http://localhost:4000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"phoneNumber":"+8613900000000","password":"Passw0rd!","role":"patient"}'

curl -X POST http://localhost:4000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"phoneNumber":"+8613900000000","password":"Passw0rd!"}'

# 4. 档案接口示例
TOKEN='上一步返回的 token'

curl -X POST http://localhost:4000/api/profiles \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"fullName":"张三","diagnosisStage":"Stage1"}'

curl -X GET http://localhost:4000/api/profiles/me \
  -H "Authorization: Bearer $TOKEN"

> **已知问题**：`npm run lint --workspace @openrd/mobile` 仍会命中 20+ 个 “React is defined but never used” 的历史报错（所有 Expo 模板页都保留了旧的 `import React`）。本次改动未清理这些文件，后续需单独处理或调整 ESLint 规则。
```

如需进一步支持（例如联调、测试或部署），请在下一阶段任务中补充说明。\*\*\*
