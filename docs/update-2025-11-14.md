# 2025-11-14 开发更新记录

## 完成事项

1. **移动端 API 封装**
   - 新建 `apps/mobile/lib/api.ts`，集中处理 `fetch` 请求、JWT 存储/读取、统一的 `apiRequest` 与错误类型。
   - 提供 `upsertPatientProfile`、`addPatientMeasurement` 等方法，后续页面可直接调用。

2. **数据录入页联调**
   - 在 `apps/mobile/screens/p-data_entry` 增加“姓名 / 诊断阶段”输入卡片，把提交按钮改为调用 `/api/profiles`（若已存在自动转为 PUT）。
   - 肌力滑杆数值同步发送到 `/api/profiles/me/measurements`，提交成功后弹窗提醒并返回上一页。
   - 样式文件补充基础信息表单的输入框/标签。

3. **忽略临时目录**
   - 更新 `.gitignore`，加入 `tmp/`、`temp/`，并移除仓库中残留的 `tmp/node-compile-cache/*`。

4. **文档更新**
   - 在 `docs/update-2025-11-06.md` 补充 “已知问题” 说明，记录移动端 lint 仍因旧的 `import React` 导致 20+ 报错。

## 验证

```bash
# 数据库已通过 11-06 脚本更新；此处重点验证 API 流程
npm run dev --workspace @openrd/api

curl -X POST http://localhost:4000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"phoneNumber":"+8613900000000","password":"Passw0rd!"}'

TOKEN='上一步返回的 token'

curl -X POST http://localhost:4000/api/profiles \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"fullName":"张三","diagnosisStage":"Stage1"}'

curl -X POST http://localhost:4000/api/profiles/me/measurements \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"muscleGroup":"deltoid","strengthScore":4}'

curl -X GET http://localhost:4000/api/profiles/me \
  -H "Authorization: Bearer $TOKEN"
```

## 已知问题

- `npm run lint --workspace @openrd/mobile` 仍会报 20+ 个 “React is defined but never used” 的历史错误（所有 Expo 模板页仍保留旧的 `import React`）。本次未清理该部分，需在后续 chore 中统一处理。

## 下一步建议

1. 登陆页接入真实 `/api/auth/login`，登录成功后调用 `setAuthToken(token)`，让移动端全局能获取 JWT。
2. 档案展示页 (`p-archive`) 调用 `/api/profiles/me` 渲染真实数据，完成 “P0-基础档案管理” 的剩余两项。
3. 计划一个 lint-cleanup 提交，批量移除 Expo 模板里多余的 `React` 导入或调整 ESLint 规则。\*\*\*
