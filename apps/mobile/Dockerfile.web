FROM node:20-alpine AS builder

WORKDIR /app

ARG EXPO_PUBLIC_API_URL=/api
ENV EXPO_PUBLIC_API_URL=${EXPO_PUBLIC_API_URL}
ENV CI=1
ENV EXPO_NO_TELEMETRY=1

COPY package.json package-lock.json ./
COPY apps/mobile/package.json ./apps/mobile/package.json
COPY apps/api/package.json ./apps/api/package.json

RUN npm ci

COPY apps/mobile ./apps/mobile

RUN npx expo export --platform web --output-dir /app/apps/mobile/dist

FROM nginx:1.27-alpine

COPY apps/mobile/nginx.conf /etc/nginx/conf.d/default.conf
COPY --from=builder /app/apps/mobile/dist /usr/share/nginx/html
